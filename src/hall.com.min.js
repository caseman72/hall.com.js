$(function() {
  var l = function(b) {
    var d = $(".hr").removeClass("hr b4").length, e = "#" + b.data("id");
    if(window.location.hash == e && d) {
      window.location.hash = "", b.siblings().removeClass("b4")
    }else {
      if(b.length) {
        window.location.hash = e, b.addClass("hr").siblings().filter(":lt(" + b.index() + ")").addClass("b4").end().filter(":gt(" + b.index() + ")").removeClass("b4").end().end()
      }
    }
  }, j = function(b) {
    var d = $.fn.re_current_user || {}, e = $.fn.re_current_users || {}, b = $(b).find("div.msg:not(.lpu)"), a = b.html();
    if(a) {
      "test" in d && d.test(a) && (a = a.replace(d, "<span class='curr'>$1</span>"), b.html(a).addClass("lpu"));
      "test" in e && e.test(a) && (a = a.replace(e, "<span class='user'>$1</span>"), b.html(a).addClass("lpu"));
      var d = $.fn.re_source_code, e = {}, f = false, c;
      if("test" in d) {
        for(;c = d.exec(a);) {
          a = a.replace(d, '<pre class="' + (c[1] || "js") + '">' + c[2] + "</pre>"), f = e[c[1] || "js"] = true
        }
        if(f) {
          for(src in b.html(a), e) {
            b.find("pre." + src).snippet(src, {style:"typical", showNum:(a.match(/\n/g) || []).length > 7})
          }
        }
      }
    }
  }, p = function() {
    (new WebKitMutationObserver(function(b) {
      for(var d = 0, e = b.length;d < e;d++) {
        var a = b[d];
        if(a.type == "childList" && a.addedNodes.length > 0) {
          for(var f = 0, c = a.addedNodes.length;f < c;f++) {
            j(a.addedNodes[f])
          }
        }
      }
    })).observe($(".hall-listview-viewport").get(0).childNodes[0], {subtree:false, childList:true, attributes:false, characterData:false, attributeOldValue:false, characterDataOldValue:false})
  };
  (function() {
    var b = false, d = false, e = [], a = function(a) {
      if(b && d && (a.disconnect(), e.length)) {
        for(var a = window.location.hash ? ("" + window.location.hash).substring(1) : null, c;c = e.pop();) {
          j(c), a && (c = $(c), c.data("id") == a && l(c))
        }
      }
    };
    (new WebKitMutationObserver(function(f, c) {
      for(var m = 0, l = f.length;m < l;m++) {
        var g = f[m];
        if(g.type == "childList" && g.addedNodes.length > 0 && g.target.nodeName == "OL") {
          if(g.target.className.match(/hall-listview-chat/)) {
            b = true;
            a(c);
            for(var i = 0, n = g.addedNodes.length;i < n;i++) {
              var h = g.addedNodes[i];
              h.nodeName == "LI" && e.push(h)
            }
            p()
          }else {
            if(g.target.className.match(/hall-listview-members/)) {
              d = true;
              a(c);
              for(var j = [], o = [], i = 0, n = g.addedNodes.length;i < n;i++) {
                if(h = g.addedNodes[i], h.nodeName == "LI") {
                  var h = $(h), k = $.trim(h.find("span[data-hall-user-id]").text());
                  k && (h.attr("data-route") ? o.push(k, k.replace(/[ ]+/g, "|")) : j.push(k, k.replace(/[ ]+/g, "|")))
                }
              }
              $.fn.re_current_users = RegExp("([@]?(?:" + o.join("|") + "))", "gi");
              $.fn.re_current_user = RegExp("([@]?(?:" + j.join("|") + "))", "gi");
              $.fn.re_source_code = /(^|html|css|js|php|sql|xml)\{\{([\s\S]+)\}\}\1?/
            }
          }
        }
      }
      a(c)
    })).observe(document, {subtree:true, childList:true, attributes:false, characterData:false, attributeOldValue:false, characterDataOldValue:false})
  })();
  $(document).on("click", "time", function(b) {
    l($(b.currentTarget).closest("li.hall-listview-li"))
  }).on("click", "li[data-hall-user-id]:not([data-route])", function() {
  })
});

